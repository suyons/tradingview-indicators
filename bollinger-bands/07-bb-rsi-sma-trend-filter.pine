//@version=6
strategy("Bollinger + RSI + SMA Trend Filter", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ğŸ”¹ [1] ì¸ë””ì¼€ì´í„° ì„¤ì • (ì‚¬ìš©ì ì…ë ¥) ê·¸ë£¹í™”
lengthBB = input.int(20, title="Bollinger Band Length", minval=1, group="Bollinger Band Parameters")
src = close
mult = input.float(2.0, title="Bollinger Band Multiplier", group="Bollinger Band Parameters")
// RSI íŒŒë¼ë¯¸í„°
rsiLength = input.int(14, title="RSI Length", minval=1, group="RSI Parameters")
// ì´ë™í‰ê· ì„  íŒŒë¼ë¯¸í„°
emaShort = input.int(50, title="Short EMA Length", minval=1, group="EMA Parameters")
emaMid = input.int(100, title="Mid EMA Length", minval=1, group="EMA Parameters")
emaLong = input.int(200, title="Long EMA Length", minval=1, group="EMA Parameters")
// ê±°ë˜ëŸ‰ í•„í„° íŒŒë¼ë¯¸í„°
volPeriod = input.int(20, title="Volume Period", minval=1, group="Volume and Volatility Parameters")
volMultiplier = input.float(1.5, title="Volume Multiplier", group="Volume and Volatility Parameters")
// ì¶”ì„¸ í•„í„° íŒŒë¼ë¯¸í„°
trendPeriod = input.int(10, title="Trend Period", minval=1, group="Trend Filter Parameters")
trendThreshold = input.float(0.6, title="Trend Threshold", minval=0, group="Trend Filter Parameters")

// ë³¼ë¦°ì € ë°´ë“œ ê³„ì‚°
basis = ta.sma(src, lengthBB)
dev = mult * ta.stdev(src, lengthBB)
upperBB = basis + dev
lowerBB = basis - dev

// RSI ê³„ì‚°
rsi = ta.rsi(src, rsiLength)

// ì´ë™ í‰ê· ì„  ê³„ì‚° (ì¶”ì„¸ ë° ë°°ì—´ í•„í„°ìš©)
ema50 = ta.ema(src, emaShort)
ema100 = ta.ema(src, emaMid)
ema200 = ta.ema(src, emaLong)

// ğŸ”¹ [2] ì´ë™í‰ê· ì„  ë°°ì—´ í•„í„° (ì •ë°°ì—´/ì—­ë°°ì—´ ì²´í¬)
isBullishTrend = ema50 > ema100 and ema100 > ema200  // ì •ë°°ì—´
isBearishTrend = ema50 < ema100 and ema100 < ema200  // ì—­ë°°ì—´

// ğŸ”¹ [3] íš¡ë³´ì¥ í•„í„° (ìµœê·¼ 30 ìº”ë“¤ ì´ë‚´ ê³¨ë“ í¬ë¡œìŠ¤ & ë°ë“œí¬ë¡œìŠ¤ í™•ì¸)
goldenCross = ta.crossover(ema50, ema100)  // 50 â†’ 100 ëŒíŒŒ
deathCross = ta.crossunder(ema50, ema100)  // 50 â†’ 100 í•˜ë½ ëŒíŒŒ

crossEvents = goldenCross ? 1 : deathCross ? -1 : 0
crossHistory = ta.sma(crossEvents, 30)  // ìµœê·¼ 30ê°œ ìº”ë“¤ ë‚´ í¬ë¡œìŠ¤ ë°œìƒ ìˆ˜

isRanging = math.abs(crossHistory) > 0  // 0ë³´ë‹¤ í¬ë©´ ìµœê·¼ 30ê°œ ìº”ë“¤ ë‚´ ê³¨ë“  & ë°ë“œ í¬ë¡œìŠ¤ê°€ ëª¨ë‘ ë°œìƒí•œ íš¡ë³´ì¥

// ğŸ”¹ [4] ë³€ë™í­ê³¼ ê±°ë˜ëŸ‰ í•„í„°
avgVol = ta.sma(volume, volPeriod)  // ìµœê·¼ `volPeriod` ê¸°ê°„ì˜ í‰ê·  ê±°ë˜ëŸ‰
maxVol = ta.highest(volume, volPeriod)  // `volPeriod` ê¸°ê°„ ë‚´ ìµœëŒ€ ê±°ë˜ëŸ‰
highVol = volume >= maxVol * volMultiplier  // ê±°ë˜ëŸ‰ì´ 1.5ë°° ì´ìƒì¼ ë•Œ

avgRange = ta.sma(high - low, volPeriod)  // ìµœê·¼ `volPeriod` ê¸°ê°„ì˜ í‰ê·  ë³€ë™í­
highRange = (high - low) >= avgRange * 1.5  // ë³€ë™í­ì´ í‰ê· ë³´ë‹¤ 1.5ë°° í¬ë©´

// ğŸ”¹ [5] ì§„ì… ì¡°ê±´ (ê°€ì¤‘ì¹˜ ë¶€ì—¬)
priceNearUpper = src >= upperBB * 0.99  // ìƒë‹¨ ê·¼ì²˜
priceNearLower = src <= lowerBB * 1.01  // í•˜ë‹¨ ê·¼ì²˜

// ë¡± ì§„ì… ì¡°ê±´: í•˜ë‹¨ ê·¼ì²˜, RSI < 40, ìƒìŠ¹ ì¶”ì„¸, íš¡ë³´ì¥ì´ ì•„ë‹ˆë©°, ê±°ë˜ëŸ‰ê³¼ ë³€ë™í­ì´ ì¶©ë¶„í•¨
longCondition = (priceNearLower ? 1 : 0) + (rsi < 40 ? 1 : 0) + (isBullishTrend ? 1 : 0) + (not isRanging ? 1 : 0) + (highVol ? 1 : 0) + (highRange ? 1 : 0)

// ìˆ ì§„ì… ì¡°ê±´: ìƒë‹¨ ê·¼ì²˜, RSI > 60, í•˜ë½ ì¶”ì„¸, íš¡ë³´ì¥ì´ ì•„ë‹ˆë©°, ê±°ë˜ëŸ‰ê³¼ ë³€ë™í­ì´ ì¶©ë¶„í•¨
shortCondition = (priceNearUpper ? 1 : 0) + (rsi > 60 ? 1 : 0) + (isBearishTrend ? 1 : 0) + (not isRanging ? 1 : 0) + (highVol ? 1 : 0) + (highRange ? 1 : 0)

// ê°€ì¤‘ì¹˜ ê¸°ì¤€ ê°’ ì„¤ì • (ì¡°ê±´ ì¶©ì¡± ì‹œ ê·¸ í•©ì´ ì´ ê°’ ì´ìƒì¼ ë•Œ ì§„ì…)
longSignalThreshold = 4  // ë¡± ì§„ì…ì„ ìœ„í•œ ìµœì†Œ ê°€ì¤‘ì¹˜
shortSignalThreshold = 4  // ìˆ ì§„ì…ì„ ìœ„í•œ ìµœì†Œ ê°€ì¤‘ì¹˜

// ğŸ”¹ [6] ë§¤ë§¤ ì§„ì…
if longCondition >= longSignalThreshold
    strategy.entry("Long", strategy.long)

if shortCondition >= shortSignalThreshold
    strategy.entry("Short", strategy.short)

// ğŸ”¹ [7] ë¡± í¬ì§€ì…˜ ì²­ì‚° ì¡°ê±´: BB ìƒë‹¨ì— ë‹¿ì•˜ì„ ë•Œ
if strategy.position_size > 0 and src >= upperBB
    strategy.close("Long")

// ğŸ”¹ [8] ìˆ í¬ì§€ì…˜ ì²­ì‚° ì¡°ê±´: BB í•˜ë‹¨ì— ë‹¿ì•˜ì„ ë•Œ
if strategy.position_size < 0 and src <= lowerBB
    strategy.close("Short")

// ğŸ”¹ [9] ë°˜ëŒ€ ì¶”ì„¸ê°€ ë°œìƒí•  ë•Œê¹Œì§€ í¬ì§€ì…˜ ìœ ì§€
if isBearishTrend and strategy.position_size > 0
    strategy.close("Long")

if isBullishTrend and strategy.position_size < 0
    strategy.close("Short")

// ğŸ”¹ [10] ì‹œê°ì  í‘œì‹œ
plot(upperBB, color=color.blue, linewidth=1, title="BB Upper")
plot(lowerBB, color=color.blue, linewidth=1, title="BB Lower")
plot(basis, color=color.orange, linewidth=1, title="BB Basis")
plot(ema50, color=color.red, linewidth=2, title="EMA 50")
plot(ema100, color=color.green, linewidth=2, title="EMA 100")
plot(ema200, color=color.blue, linewidth=2, title="EMA 200")